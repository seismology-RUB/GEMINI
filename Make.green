#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#  This is the generic part of the Makefile. Use this
#  template within each project.
#
#  General definitions
#
F2C = f2c
AR = ar
F2CFLAGS = -f -u
CFLAGS = -O3
#-------------------------------------------------------
#  Direcory search
#
vpath %.o $(obsdir)
#-------------------------------------------------------
#  Implicit rule to compile .o files from .f files.
#  Output of f2c stays in directory where .f files are.
#  Substitute .f by .c in dependency and compile target.
#  Then remove .c files.
#  Because of vpath, targets and dependencies need not be
#  in the current directory.
#
%.o: %.f
	$(F2C) $(F2CFLAGS) -d$(dir $<) $<
	$(CC) -c $(CFLAGS) $(dir $<)$*.c -o $(obsdir)/$@
	-rm -f $(dir $<)$*.c
%.o: %.c
	$(CC) -c $(CFLAGS) $< -o $(obsdir)/$@
#--------------------------------------------------------------
#  Object string for linking:
#  Adds object dir as prefix and removes directory part
#  of $^ (all dependencies)
#
obstring = $(addprefix $(obsdir)/,$(notdir $^))
#
#   End of generic part of Makefile
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#  Paths
#
bindir = .
obsdir = ./objects
#
#  Library paths
#
f2clib = -L/usr/lib -lf2c -lm
#-----------------------------------------------------------
# Dependent o-files
#
OBS = propag.o sysminors.o stavani.o sysliq.o earthmodel_procs.o \
	syssolidt.o nodes_procs.o startr.o flnm_procs.o bsint_procs.o zetl.o \
	sterms.o minorint.o greenint.o reciprocity.o zelcon.o \
	frechet.o layer_procs.o flgevas_init.o isoptbelpar.o sphancf.o \
	greenkfsph.o greenkftor.o systor.o torint.o frechettor.o hatkernel.o \
	stavsurf.o sphan2cf.o
STUFF = sunfortran.o gse20.o stuff.o
WOLIB = tf_cmdline.o trim.o splitstring.o dsplco.o zsplco.o dlocate.o hbutcw.o \
	geo2epi.o bessy0.o bessy1.o bessj0.o bessj1.o ceil.o sft.o causfalt.o \
	pythag.o bessj.o bessy.o hbutrw.o spline_interpol_2p.o locate.o
#-------------------------------------------------------------
#  create dependencies on .h-files
#  make.incdep is a Makefile because it is included. Such files are first updated
#  before anything else and make starts from anew including all updated makefiles
#
make.incdep: *.f *.f.m4
	./incdep-wf.sh > make.incdep
-include make.incdep
#----------------------------------------------------------------
#  - create some h-files and f-files from their m4 templates
#    thus one .h file can be used in different programs with
#    varying values of the dimensions
#  - to change the default settings in the .m4 files say
#    touch *.h.m4
#    make VARNAME=VALUE target
#
NSTATT=50
NKFMAX=150000
NND=100
NPP=3000
%.h: %.h.m4
	m4 -Dm4_nstatt=$(NSTATT) -Dm4_nnd=$(NND) -Dm4_nkfmax=$(NKFMAX) \
	   -Dm4_npp=$(NPP) \
	   -Dm4_elcon_type=\`double\ complex\' $< > $@
%.f: %.f.m4
	m4 -Dm4_function_type=\`double\ complex\' -DGREEN \
	   -Dm4_elcon_type=\`double\ complex\' $< > $@ 
#----------------------------------------------------------------
#       Targets
#
flgevask: %: %.o $(OBS) $(WOLIB)
	$(CC) -o $(bindir)/$@ $(obstring) $(f2clib)
seismogram: %: %.o sar_procs.o green_procs.o seismo_procs.o $(WOLIB) $(STUFF)
	$(CC) -o $(bindir)/$@ $(obstring) $(f2clib)
greenseis: %: %.o sar_procs.o green_procs.o seismo_procs.o $(WOLIB) $(STUFF)
	$(CC) -o $(bindir)/$@ $(obstring) $(f2clib)
